<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日本東京・輕井澤之旅</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Config & Custom Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 北歐風色系 (Nordic Palette)
                        nordic: {
                            bg: '#fdfbf7',       /* 燕麥白背景 */
                            card: '#ffffff',     /* 純白卡片 */
                            text: '#2c3e50',     /* 深藍灰文字 */
                            sub: '#7f8c8d',      /* 淺灰輔助字 */
                            primary: '#5d737e',  /* 霧霾藍 (主色) */
                            accent: '#d4a373',   /* 淺木色 (強調) */
                            green: '#88b04b',    /* 草木綠 */
                            red: '#e07a5f',      /* 陶土紅 */
                            border: '#e5e7eb',   /* 極淺灰邊框 */
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            color: #2c3e50;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
            /* 基礎字體大小 */
            font-size: 19px; 
            line-height: 1.6;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page-section {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding-bottom: 200px; 
        }
        .page-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 輸入框字體大小 */
        input, textarea, select { font-size: 20px !important; }

        .loader {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #5d737e;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden bg-nordic-bg">

    <!-- Header (北歐風填滿色彩 - 高度縮減) -->
    <header class="bg-nordic-primary px-5 py-3 shadow-sm z-20 sticky top-0 text-white flex justify-between items-center">
        <div class="flex items-baseline gap-3">
            <h1 class="text-lg font-bold tracking-widest text-white leading-none">TOKYO TRIP</h1>
            <p class="text-xs text-nordic-bg opacity-80 leading-none font-medium tracking-wide">2026.01.27 - 02.03</p>
        </div>
        <div>
            <button onclick="openSettings()" class="text-white hover:text-nordic-accent transition opacity-80 hover:opacity-100">
                <i class="fas fa-cog text-lg"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-5 relative" id="main-container">
        
        <!-- SECTION 1: PLAN (行程表) -->
        <section id="plan" class="page-section active">
            <!-- Flight Card -->
            <div class="bg-nordic-card rounded-lg p-5 border border-nordic-border mb-5 relative overflow-hidden shadow-sm">
                <!-- 裝飾線條 -->
                <div class="absolute top-0 left-0 w-1 h-full bg-nordic-primary"></div>
                
                <h3 class="font-bold text-lg text-nordic-text mb-4 flex items-center">
                    <i class="fas fa-plane text-nordic-primary mr-3 text-sm"></i>航班資訊
                </h3>
                <div class="flex justify-between items-center text-base mb-4">
                    <div class="text-center">
                        <span class="block text-xs text-nordic-sub mb-1">去程 1/27</span>
                        <span class="font-bold text-lg">MM626</span>
                    </div>
                    <div class="text-center px-4 flex-1">
                        <div class="border-b border-nordic-border relative top-[-8px]"></div>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-nordic-sub mb-1">10:40-14:55</span>
                        <span class="font-bold text-lg">TPE → NRT</span>
                    </div>
                </div>
                <div class="flex justify-between items-center text-base">
                    <div class="text-center">
                        <span class="block text-xs text-nordic-sub mb-1">回程 2/3</span>
                        <span class="font-bold text-lg">MM623</span>
                    </div>
                    <div class="text-center px-4 flex-1">
                        <div class="border-b border-nordic-border relative top-[-8px]"></div>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-nordic-sub mb-1">10:55-14:20</span>
                        <span class="font-bold text-lg">NRT → TPE</span>
                    </div>
                </div>
            </div>

            <!-- Accommodation Card -->
            <div class="bg-nordic-card rounded-lg p-5 border border-nordic-border mb-8 relative overflow-hidden shadow-sm">
                <div class="absolute top-0 left-0 w-1 h-full bg-nordic-accent"></div>
                <h3 class="font-bold text-lg text-nordic-text mb-4 flex items-center">
                    <i class="fas fa-bed text-nordic-accent mr-3 text-sm"></i>住宿安排
                </h3>
                <div id="hotel-list" class="space-y-5">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- Daily Itinerary -->
            <h3 class="text-lg font-bold text-nordic-text mb-5 pl-2 border-l-4 border-nordic-green">
                每日行程
            </h3>
            <div id="itinerary-list" class="space-y-4">
                <!-- JS Injected -->
            </div>
        </section>


        <!-- SECTION 2: GUIDE (深度導覽) -->
        <section id="guide" class="page-section">
            <article class="bg-nordic-card p-6 rounded-lg border border-nordic-border mb-6 shadow-sm">
                <h2 class="text-2xl font-bold text-nordic-text mb-1">川越 Kawagoe</h2>
                <p class="text-xs text-nordic-sub uppercase tracking-widest mb-4">Little Edo / Saitama</p>
                
                <p class="text-base leading-7 text-justify text-nordic-text opacity-90 mb-4">
                    川越被稱為「小江戶」，這裡保留了大量江戶時代的「藏造」建築（倉庫式建築），黑瓦與厚重的牆壁是其特徵。
                    <br><br>
                    <strong>必去亮點：</strong>
                    <ul class="list-disc list-inside mt-2 mb-4 space-y-2 text-base">
                        <li><strong>時之鐘：</strong>川越的地標，每天會有四次報時（6點、12點、15點、18點），充滿懷舊風情。</li>
                        <li><strong>冰川神社：</strong>以結緣聞名，最特別的是「釣鯛魚」御神籤，用釣竿釣起紅色的平安鯛（求平安）或粉色的良緣鯛（求姻緣）。</li>
                        <li><strong>菓子屋橫丁：</strong>一條充滿懷舊糖果香氣的街道，可以買到巨大的黑糖棒與各式傳統零食。</li>
                    </ul>
                    這裡的星巴克也是必去景點，採用江戶風格庭園設計，完美融入古色古香的街道中。必吃美食包括紫薯甜點與鰻魚飯。
                </p>
                <div class="bg-gray-50 p-3 rounded text-sm text-nordic-text border border-gray-100">
                    <i class="fas fa-lightbulb text-nordic-accent mr-2"></i><span class="opacity-80">小知識：川越的鬼瓦有各種表情。</span>
                </div>
            </article>

            <article class="bg-nordic-card p-6 rounded-lg border border-nordic-border mb-6 shadow-sm">
                <h2 class="text-2xl font-bold text-nordic-text mb-1">輕井澤 Karuizawa</h2>
                <p class="text-xs text-nordic-sub uppercase tracking-widest mb-4">Highland Resort / Nagano</p>
                
                <!-- 圖片已移除 -->

                <p class="text-base leading-7 text-justify text-nordic-text opacity-90 mb-4">
                    日本皇室的避暑勝地，充滿濃厚的歐洲風情。
                    <br><br>
                    <strong>自然與建築之美：</strong>
                    <ul class="list-disc list-inside mt-2 mb-4 space-y-2 text-base">
                        <li><strong>雲場池：</strong>又名「天鵝湖」，四季景色分明，湖面倒映著周圍的樹林，極為幽靜美麗。</li>
                        <li><strong>石之教堂：</strong>由石頭與玻璃相互堆砌而成，象徵著男性的堅毅與女性的柔和，陽光透過玻璃灑落，氛圍神聖。</li>
                        <li><strong>輕井澤高原教堂：</strong>位於森林深處的巨大三角形木造教堂，溫暖而莊嚴。</li>
                        <li><strong>榆樹街小鎮 (Harunire Terrace)：</strong>位於星野區，由高架木棧道連接數間個性店鋪，周圍被榆樹環繞，非常適合散步與下午茶。</li>
                    </ul>
                </p>
            </article>

            <!-- Shibuya Sky (New Added) -->
            <article class="bg-nordic-card p-6 rounded-lg border border-nordic-border mb-6 shadow-sm">
                <h2 class="text-2xl font-bold text-nordic-text mb-1">澀谷 Shibuya Sky</h2>
                <p class="text-xs text-nordic-sub uppercase tracking-widest mb-4">Tokyo / Landmark</p>
                <p class="text-base leading-7 text-justify text-nordic-text opacity-90 mb-4">
                    東京目前最熱門的觀景台，位於 Shibuya Scramble Square 頂樓。擁有 360 度的露天展望台，可以俯瞰著名的澀谷十字路口、東京鐵塔與晴空塔，天氣好時甚至能看見富士山。建議傍晚前往，一次飽覽日落與繁華夜景。
                </p>
            </article>

            <!-- Embedded Map -->
            <div class="bg-nordic-card p-4 rounded-lg border border-nordic-border shadow-sm">
                <h3 class="text-base font-bold text-nordic-text mb-3 flex items-center">
                    <i class="fas fa-map-marker-alt text-nordic-red mr-2"></i>東京迪士尼度假區
                </h3>
                <div class="w-full h-56 bg-gray-100 rounded overflow-hidden">
                    <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=139.8708%2C35.6243%2C139.8950%2C35.6360&amp;layer=mapnik" style="border: none"></iframe>
                </div>
                <div class="text-right mt-2">
                    <a href="https://www.openstreetmap.org/#map=15/35.6301/139.8829" target="_blank" class="text-sm font-bold text-nordic-primary hover:text-nordic-text transition">查看地圖 <i class="fas fa-arrow-right text-xs ml-1"></i></a>
                </div>
            </div>
        </section>


        <!-- SECTION 3: WALLET (記帳與匯率) -->
        <section id="wallet" class="page-section">
            
            <!-- Exchange Rate Calculator -->
            <div class="bg-nordic-primary text-white p-5 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-end mb-3">
                    <label class="text-sm text-gray-200">匯率設定</label>
                    <input type="number" id="rate-input" step="0.001" value="0.20" class="w-20 bg-white/20 text-white text-center rounded text-base p-1 outline-none focus:ring-1 focus:ring-white font-bold backdrop-blur-sm">
                </div>
                
                <div class="mb-3 relative">
                    <span class="absolute left-3 top-3 text-gray-300 text-lg">¥</span>
                    <input type="text" id="calc-input" placeholder="輸入算式 (如 500*2)" class="w-full bg-white/10 text-white text-3xl p-2 pl-8 rounded outline-none font-mono tracking-wider placeholder-gray-400">
                </div>
                
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/20">
                    <div class="text-gray-200 text-sm">≈ NT$ <span id="twd-preview" class="text-white font-bold text-xl ml-1">0</span></div>
                    <button onclick="calculateAndAdd()" class="bg-white text-nordic-primary px-5 py-2 rounded text-sm font-bold shadow-sm hover:bg-gray-100 active:scale-95 transition">
                        填入
                    </button>
                </div>
            </div>

            <!-- Add Expense Form -->
            <div class="bg-nordic-card p-5 rounded-lg border border-nordic-border mb-6 relative overflow-hidden shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-nordic-text">新增記帳</h3>
                    <!-- AI Scan Button -->
                    <label class="bg-gray-100 text-nordic-text px-3 py-1.5 rounded-full text-xs font-bold cursor-pointer hover:bg-gray-200 transition flex items-center gap-2 border border-gray-200">
                        <i class="fas fa-magic text-nordic-primary"></i> AI 掃描
                        <input type="file" accept="image/*" class="hidden" onchange="handleAiScan(this)">
                    </label>
                </div>
                
                <div class="mb-4 space-y-3">
                    <!-- Row 1: Day Select -->
                    <select id="expense-day" class="w-full border border-nordic-border rounded p-2.5 text-base bg-nordic-bg focus:bg-white focus:border-nordic-primary outline-none transition font-bold text-nordic-text">
                        <!-- Options JS Injected -->
                    </select>
                    
                    <!-- Row 2: Name -->
                    <input type="text" id="item-name" placeholder="品項名稱" class="w-full border border-nordic-border rounded p-3 text-base bg-nordic-bg focus:bg-white focus:border-nordic-primary outline-none transition">
                    
                    <!-- Row 3: Amount, Currency, Payer -->
                    <div class="flex gap-2">
                        <!-- Amount (Short) -->
                        <input type="number" id="item-price" placeholder="金額" class="w-1/3 min-w-0 border border-nordic-border rounded p-2.5 text-base bg-nordic-bg focus:bg-white focus:border-nordic-primary outline-none transition">
                        
                        <!-- Currency -->
                        <select id="item-currency" class="w-1/3 min-w-[70px] border border-nordic-border rounded p-2.5 text-sm bg-nordic-bg focus:bg-white focus:border-nordic-primary outline-none transition text-center font-bold text-nordic-text">
                            <option value="JPY">JPY ¥</option>
                            <option value="TWD">TWD $</option>
                        </select>
                        <!-- Payer -->
                        <select id="item-payer" class="w-1/3 min-w-[70px] border border-nordic-border rounded p-2.5 text-sm bg-nordic-bg focus:bg-white focus:border-nordic-primary outline-none transition text-center font-bold text-nordic-text">
                            <option value="E">E</option>
                            <option value="H">H</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <label class="flex-1 bg-nordic-bg text-nordic-sub border border-nordic-border border-dashed rounded flex flex-col items-center justify-center p-3 cursor-pointer hover:bg-white transition">
                        <i class="fas fa-camera mb-1"></i>
                        <span class="text-xs" id="photo-label">存底圖</span>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                    </label>
                    <button onclick="addExpense()" class="flex-[2] bg-nordic-text text-white rounded p-3 font-bold text-base hover:opacity-90 active:scale-95 transition">
                        儲存紀錄
                    </button>
                </div>
                <div id="photo-preview-area" class="mt-3 hidden">
                    <img id="preview-img" class="h-20 w-20 object-cover rounded border border-nordic-border" src="">
                    <span class="text-sm text-nordic-green ml-2"><i class="fas fa-check-circle"></i> 圖片已準備</span>
                </div>

                <!-- AI Loading Overlay -->
                <div id="ai-scan-loading" class="absolute inset-0 bg-white/90 z-10 hidden flex flex-col items-center justify-center">
                    <div class="loader mb-2"></div>
                    <span class="text-sm text-nordic-primary font-bold">辨識中...</span>
                </div>
            </div>

            <!-- Expense History & Split Result -->
            <div class="mb-3 px-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg text-nordic-text">消費紀錄</h3>
                    <span class="text-xs font-bold bg-nordic-accent text-white px-2 py-1 rounded" id="total-expense">總: NT$0</span>
                </div>
                
                <div class="flex gap-2 justify-end text-xs font-bold text-nordic-sub mb-2">
                    <span class="bg-gray-100 px-2 py-1 rounded border border-gray-200" id="subtotal-e">E: NT$0</span>
                    <span class="bg-gray-100 px-2 py-1 rounded border border-gray-200" id="subtotal-h">H: NT$0</span>
                </div>

                <!-- Split Result -->
                <div id="split-result" class="text-right text-sm font-bold text-nordic-text bg-nordic-bg p-3 rounded border border-nordic-border shadow-sm">
                    尚無分帳資料
                </div>
            </div>
            
            <div id="expense-list" class="space-y-6 pb-10"> <!-- Increased space for grouping -->
                <!-- JS Injected items -->
                <div class="text-center py-12 text-gray-300 text-sm">尚未有記帳資料</div>
            </div>
        </section>


        <!-- SECTION 4: LISTS (清單) -->
        <section id="lists" class="page-section">
            
            <!-- Check List -->
            <div class="bg-nordic-card rounded-lg border border-nordic-border mb-8 overflow-hidden shadow-sm">
                <div class="bg-gray-50 text-nordic-text p-4 flex justify-between items-center border-b border-nordic-border">
                    <h3 class="font-bold text-lg"><i class="fas fa-check-double mr-2 text-nordic-primary"></i>行前準備</h3>
                    <button onclick="resetChecklist()" class="text-xs text-nordic-sub bg-white border border-nordic-border px-2 py-1 rounded hover:bg-gray-50">重置</button>
                </div>
                
                <div id="checklist-container" class="divide-y divide-nordic-border max-h-[60vh] overflow-y-auto pb-24">
                    <!-- JS Injected -->
                </div>
                
                <!-- Input Area (Sticky at bottom left) - Modified Position -->
                <div class="p-4 bg-nordic-bg border-t border-nordic-border sticky bottom-[55px] z-30 shadow-sm">
                     <div class="flex flex-col gap-3">
                        <input type="text" id="new-todo" placeholder="新增待辦事項..." class="w-full border border-nordic-border rounded p-3 text-base bg-white focus:border-nordic-primary outline-none">
                        <div class="flex justify-start">
                            <button onclick="addTodo()" class="bg-nordic-primary text-white px-6 py-2 rounded text-base font-bold shadow-sm hover:opacity-90 active:scale-95 transition flex items-center">
                                <i class="fas fa-plus mr-2"></i>新增
                            </button>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Memos -->
            <div class="bg-nordic-card rounded-lg border border-nordic-border p-5 shadow-sm">
                <h3 class="font-bold text-lg text-nordic-text mb-4"><i class="fas fa-pen text-nordic-accent mr-2"></i>備忘錄</h3>
                <textarea id="memo-area" class="w-full h-48 border border-nordic-border rounded p-4 text-base leading-relaxed bg-nordic-bg focus:bg-white focus:border-nordic-primary transition resize-none outline-none" placeholder="輸入文字或網址..."></textarea>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-xs text-nordic-sub">網址將自動轉換為按鈕</span>
                    <button onclick="saveMemo()" class="bg-nordic-text text-white px-5 py-1.5 rounded text-sm font-bold shadow-sm hover:opacity-90 transition">儲存</button>
                </div>
                <div id="memo-links" class="mt-4 flex flex-wrap gap-2">
                    <!-- Links parsed from textarea -->
                </div>
            </div>
        </section>


        <!-- SECTION 5: INFO (資訊) -->
        <section id="info" class="page-section">
            
            <!-- Google Translate Card -->
            <a href="https://translate.google.com/?sl=zh-TW&tl=ja&op=translate" target="_blank" class="block bg-white p-5 rounded-lg border border-nordic-border mb-6 shadow-sm hover:shadow-md transition group">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                            <i class="fas fa-language text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-nordic-text group-hover:text-nordic-primary transition">Google 翻譯 (中 ⮕ 日)</h3>
                            <p class="text-sm text-nordic-sub">開啟線上翻譯工具</p>
                        </div>
                    </div>
                    <i class="fas fa-external-link-alt text-nordic-sub group-hover:text-nordic-primary"></i>
                </div>
            </a>

            <div class="grid grid-cols-2 gap-4">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-nordic-card p-5 rounded-lg border border-nordic-border flex flex-col items-center justify-center text-center aspect-square hover:bg-gray-50 transition shadow-sm">
                    <i class="fas fa-cloud-sun text-4xl text-nordic-primary mb-3"></i>
                    <span class="font-bold text-base text-nordic-text">天氣預報</span>
                </a>
                <a href="https://www.google.com/maps/search/?api=1&query=police+station+near+me" target="_blank" class="bg-nordic-card p-5 rounded-lg border border-nordic-border flex flex-col items-center justify-center text-center aspect-square hover:bg-gray-50 transition shadow-sm">
                    <i class="fas fa-shield-alt text-4xl text-nordic-red mb-3"></i>
                    <span class="font-bold text-base text-nordic-text">緊急求助</span>
                </a>
            </div>

            <div class="bg-nordic-card rounded-lg border border-nordic-border p-5 mt-6 border-l-4 border-l-nordic-accent shadow-sm">
                <h3 class="font-bold text-lg text-nordic-text mb-3">注意事項</h3>
                <ul class="list-disc list-inside text-base text-nordic-text opacity-80 space-y-2">
                    <li>日本電壓為 100V。</li>
                    <li>電車內請勿通話。</li>
                    <li>多數餐廳禁帶外食。</li>
                    <li>垃圾請隨身攜帶。</li>
                    <li>購物滿 5000 日圓可退稅。</li>
                </ul>
            </div>

             <div class="bg-nordic-card rounded-lg border border-nordic-border p-5 mt-6 shadow-sm">
                <h3 class="font-bold text-lg text-nordic-text mb-4">緊急聯絡</h3>
                <div class="space-y-4 text-base">
                    <div class="flex justify-between border-b border-nordic-border pb-2">
                        <span class="text-nordic-sub">報警</span>
                        <a href="tel:110" class="text-nordic-text font-bold">110</a>
                    </div>
                    <div class="flex justify-between border-b border-nordic-border pb-2">
                        <span class="text-nordic-sub">救護車</span>
                        <a href="tel:119" class="text-nordic-red font-bold">119</a>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-nordic-sub text-sm mb-1">台北駐日經濟文化代表處</span>
                        <a href="tel:+81-3-3280-7811" class="text-nordic-text font-bold">03-3280-7811</a>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 text-center">
                 <button onclick="clearAllData()" class="text-sm text-nordic-sub underline p-3 hover:text-nordic-red transition">清除所有資料 (Reset)</button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation (Compact Style) -->
    <nav class="bg-white/95 backdrop-blur-sm border-t border-nordic-border flex justify-around items-center py-2 text-xs font-medium z-50 fixed bottom-0 w-full text-nordic-sub">
        <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center py-0.5 w-1/5 text-nordic-accent transition" data-target="plan">
            <i class="fas fa-calendar-alt text-xl mb-0.5"></i>
            <span class="text-[10px]">行程</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center py-0.5 w-1/5 hover:text-nordic-text transition" data-target="guide">
            <i class="fas fa-book-open text-xl mb-0.5"></i>
            <span class="text-[10px]">導覽</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center py-0.5 w-1/5 hover:text-nordic-text transition" data-target="wallet">
            <i class="fas fa-wallet text-xl mb-0.5"></i>
            <span class="text-[10px]">記帳</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center py-0.5 w-1/5 hover:text-nordic-text transition" data-target="lists">
            <i class="fas fa-list-ul text-xl mb-0.5"></i>
            <span class="text-[10px]">清單</span>
        </button>
        <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center py-0.5 w-1/5 hover:text-nordic-text transition" data-target="info">
            <i class="fas fa-info-circle text-xl mb-0.5"></i>
            <span class="text-[10px]">資訊</span>
        </button>
    </nav>

    <!-- Modal for Large Image View -->
    <div id="image-modal" class="fixed inset-0 bg-white/90 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <img id="modal-img" src="" class="max-w-full max-h-full rounded shadow-xl">
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/20 hidden z-50 flex items-center justify-center p-5 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl border border-nordic-border max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg text-nordic-text mb-4 flex items-center"><i class="fas fa-sliders-h text-nordic-primary mr-2"></i>設定</h3>
            
            <div class="mb-5">
                <label class="text-sm font-bold text-nordic-sub mb-2 block">Google Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="Paste Key here..." class="w-full border border-nordic-border rounded p-3 text-base focus:border-nordic-primary outline-none transition bg-nordic-bg">
            </div>

            <div class="mb-6">
                <label class="text-sm font-bold text-nordic-sub mb-2 block">AI Model</label>
                <select id="model-select" class="w-full border border-nordic-border rounded p-3 text-base bg-nordic-bg focus:border-nordic-primary outline-none transition">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (快)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (強)</option>
                </select>
            </div>

            <!-- New Sync Feature -->
            <div class="mb-6 pt-4 border-t border-nordic-border">
                <h4 class="font-bold text-nordic-text mb-3 flex items-center"><i class="fas fa-sync-alt text-nordic-green mr-2"></i>資料同步 (備份/還原)</h4>
                
                <div class="mb-3">
                    <button onclick="exportData()" class="w-full bg-nordic-accent text-white px-4 py-2 rounded text-sm font-bold shadow-sm hover:opacity-90 transition mb-2">
                        <i class="fas fa-file-export mr-2"></i>匯出資料 (複製代碼)
                    </button>
                    <p class="text-[10px] text-nordic-sub">複製後的代碼可傳給旅伴，供其匯入。</p>
                </div>

                <div>
                    <textarea id="import-data-input" placeholder="在此貼上旅伴傳來的資料代碼..." class="w-full border border-nordic-border rounded p-2 text-xs bg-nordic-bg h-20 mb-2 focus:border-nordic-primary outline-none"></textarea>
                    <button onclick="importData()" class="w-full bg-nordic-text text-white px-4 py-2 rounded text-sm font-bold shadow-sm hover:opacity-90 transition">
                        <i class="fas fa-file-import mr-2"></i>匯入資料 (覆蓋現有)
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-2 border-t border-nordic-border">
                <button onclick="closeSettings()" class="text-nordic-sub text-sm px-4 py-2 hover:bg-gray-50 rounded transition">取消</button>
                <button onclick="saveSettings()" class="bg-nordic-text text-white px-5 py-2 rounded text-sm font-bold shadow-sm hover:opacity-90 transition">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- Data Definitions ---
        const hotels = [
            { name: "Spa & Hotel Maihama Eurasia", address: "Chiba, Urayasu, Chidori, 13-20", note: "迪士尼周邊" },
            { name: "Hotel Rosso Karuizawa", address: "154-2 Karuizawahigashi, Nagano", note: "輕井澤車站旁" },
            { name: "Hotel Kangetsuso Ueno", address: "2 Chome-14-28 Ueno, Taito City, Tokyo", note: "上野鬧區" }
        ];

        // Defined days for dropdown and sorting
        const itineraryDays = ["D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8"];
        
        const itinerary = [
            { day: "D1", date: "1/27 (二)", title: "抵日・舞濱入住", highlight: false, hotel: "Spa & Hotel Maihama Eurasia", content: "桃園機場 → 成田機場 → 前往舞濱 Check-in → 休息/周邊逛逛" },
            { day: "D2", date: "1/28 (三)", title: "東京迪士尼陸地樂園", highlight: false, hotel: "Spa & Hotel Maihama Eurasia", content: "全日迪士尼 Land (建議提早入園排隊)" },
            { day: "D3", date: "1/29 (四)", title: "東京迪士尼海洋", highlight: false, hotel: "Spa & Hotel Maihama Eurasia", content: "全日迪士尼 Sea (欣賞夜間遊行)" },
            { day: "D4", date: "1/30 (五)", title: "川越半日遊", highlight: false, hotel: "Hotel Rosso Karuizawa", content: "移動至東京 → 前往川越 (冰川神社、藏造老街、鐘樓) → 前往輕井澤" },
            { day: "D5", date: "1/31 (六)", title: "輕井澤與自然", highlight: false, hotel: "Hotel Rosso Karuizawa", content: "雲場池 → 舊輕井澤銀座通 → 聖保羅天主教堂 → 白絲瀑布" }, 
            { day: "D6", date: "2/1 (日)", title: "星野區與 Outlet", highlight: false, hotel: "Hotel Kangetsuso Ueno", content: "中輕井澤星野區 → 榆樹街小鎮 → 石之教堂/高原教堂 → 村民食堂午餐 → 王子購物廣場 Outlet → 返回東京" },
            { day: "D7", date: "2/2 (一)", title: "東京市區巡禮", highlight: false, hotel: "Hotel Kangetsuso Ueno", content: "上野 → 根津神社 → 谷中銀座 → 麻布台之丘 → Shibuya Sky (澀谷夜景)" },
            { day: "D8", date: "2/3 (二)", title: "返台", highlight: false, hotel: "", content: "搭 Skyliner 前往成田機場 → 免稅店採購 → 搭機回台灣" }
        ];

        const defaultTodos = [
            "護照 (有效期限6個月以上)", "Visit Japan Web 填寫", "網卡/漫遊開通", "日幣現金", "信用卡/西瓜卡", 
            "充電器/轉接頭", "個人常備藥", "迪士尼門票 QR Code"
        ];

        // --- App State ---
        let currentRate = 0.20;
        let expenses = [];
        let userItinerary = {}; // User spots
        let userDayNotes = {}; // User notes (New)
        let todos = [];
        let tempPhotoData = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initDaySelect();
            renderHotels();
            renderItinerary();
            renderExpenses();
            renderTodos();
            renderMemoLinks();
            
            // Tab Handling
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update UI
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('text-nordic-accent');
                        b.classList.add('text-nordic-sub');
                    });
                    this.classList.remove('text-nordic-sub');
                    this.classList.add('text-nordic-accent');

                    // Show Section
                    const target = this.dataset.target;
                    switchTab(target);
                });
            });

            // Rate Input Listener
            document.getElementById('rate-input').addEventListener('input', (e) => {
                currentRate = parseFloat(e.target.value) || 0.20;
                localStorage.setItem('japan_rate', currentRate);
                calcRate(); 
                renderExpenses();
            });

            // Calculator Input Listener
            document.getElementById('calc-input').addEventListener('input', calcRate);
        });

        // --- Core Functions ---

        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function loadData() {
            // Rate
            const savedRate = localStorage.getItem('japan_rate');
            if (savedRate) {
                currentRate = parseFloat(savedRate);
                document.getElementById('rate-input').value = currentRate;
            } else {
                 document.getElementById('rate-input').value = currentRate;
            }

            // Expenses
            const savedExp = localStorage.getItem('japan_expenses');
            if (savedExp) expenses = JSON.parse(savedExp);

            // User Itinerary
            const savedUserItin = localStorage.getItem('japan_user_itinerary');
            if (savedUserItin) userItinerary = JSON.parse(savedUserItin);

            // User Notes
            const savedUserNotes = localStorage.getItem('japan_user_notes');
            if (savedUserNotes) userDayNotes = JSON.parse(savedUserNotes);

            // Todos
            const savedTodos = localStorage.getItem('japan_todos');
            if (savedTodos) {
                todos = JSON.parse(savedTodos);
            } else {
                todos = defaultTodos.map(t => ({ text: t, done: false }));
            }

            // Memo
            const savedMemo = localStorage.getItem('japan_memo');
            if (savedMemo) document.getElementById('memo-area').value = savedMemo;
        }

        // --- Init Day Select ---
        function initDaySelect() {
            const select = document.getElementById('expense-day');
            
            // Populate options
            select.innerHTML = itinerary.map(item => 
                `<option value="${item.day}">${item.date}</option>`
            ).join('') + `<option value="Other">其他</option>`;
            
            // Try to set default to today if in range
            const today = new Date();
            // Simplified check - hardcoded year for demo logic, ideal is parsing real dates
            // Assuming 2026 for trip. This logic is just a placeholder for "auto-select today"
            // For a static app, defaulting to D1 is safe if not matching.
            select.value = "D1"; 
        }

        // --- Sync Functions (Export/Import) ---
        function exportData() {
            const data = {
                rate: currentRate,
                expenses: expenses,
                userItinerary: userItinerary,
                userDayNotes: userDayNotes,
                todos: todos,
                memo: document.getElementById('memo-area').value
            };
            const jsonStr = JSON.stringify(data);
            
            // Try to copy to clipboard
            navigator.clipboard.writeText(jsonStr).then(() => {
                alert("資料代碼已複製到剪貼簿！請傳送給旅伴。");
            }, () => {
                // Fallback
                alert("自動複製失敗，請手動複製以下代碼：\n\n" + jsonStr);
            });
        }

        function importData() {
            const inputStr = document.getElementById('import-data-input').value;
            if (!inputStr) {
                alert("請先貼上資料代碼！");
                return;
            }
            try {
                const data = JSON.parse(inputStr);
                
                if (confirm("警告：這將會覆蓋您目前所有的記帳與清單資料，確定要匯入嗎？")) {
                    if (data.rate) localStorage.setItem('japan_rate', data.rate);
                    if (data.expenses) localStorage.setItem('japan_expenses', JSON.stringify(data.expenses));
                    if (data.userItinerary) localStorage.setItem('japan_user_itinerary', JSON.stringify(data.userItinerary));
                    if (data.userDayNotes) localStorage.setItem('japan_user_notes', JSON.stringify(data.userDayNotes));
                    if (data.todos) localStorage.setItem('japan_todos', JSON.stringify(data.todos));
                    if (data.memo) localStorage.setItem('japan_memo', data.memo);
                    
                    alert("匯入成功！頁面將重新整理。");
                    location.reload();
                }
            } catch (e) {
                alert("資料格式錯誤，請確認代碼是否完整。");
            }
        }

        // --- Render Functions ---

        function renderHotels() {
            const container = document.getElementById('hotel-list');
            container.innerHTML = hotels.map(h => `
                <div class="border-b border-nordic-border last:border-0 pb-3 last:pb-0">
                    <div class="font-bold text-nordic-text text-lg">${h.name}</div>
                    <div class="text-sm text-nordic-sub mt-1"><i class="fas fa-map-marker-alt mr-2 text-nordic-accent"></i>${h.address}</div>
                    <div class="mt-3 flex gap-2">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name + ' ' + h.address)}" target="_blank" class="bg-gray-100 hover:bg-gray-200 text-nordic-text px-3 py-1 rounded text-xs transition font-medium">Google Maps</a>
                        <span class="text-xs text-nordic-accent border border-nordic-accent px-2 py-1 rounded">${h.note}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- Auto Link Function ---
        function autoLink(text) {
            const keywords = [
                "冰川神社", "藏造老街", "鐘樓", "雲場池", "舊輕井澤銀座通", 
                "聖保羅天主教堂", "白絲瀑布", "中輕井澤星野區", "榆樹街小鎮", 
                "石之教堂", "高原教堂", "村民食堂", "王子購物廣場", 
                "根津神社", "谷中銀座", "麻布台之丘", "Shibuya Sky",
                "神社", "寺", "公園", "塔", "苑" // General keywords
            ];
            
            let linkedText = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(keyword, 'g');
                const link = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}" target="_blank" class="text-nordic-primary font-bold underline decoration-nordic-primary/30 underline-offset-4 hover:text-nordic-text transition">${keyword}</a>`;
                linkedText = linkedText.replace(regex, link);
            });
            return linkedText;
        }

        function addUserSpot(day) {
            const input = document.getElementById(`spot-input-${day}`);
            const text = input.value.trim();
            if (!text) return;

            if (!userItinerary[day]) userItinerary[day] = [];
            userItinerary[day].push(text);
            
            localStorage.setItem('japan_user_itinerary', JSON.stringify(userItinerary));
            renderItinerary(); // Re-render to show new spot
        }

        function removeUserSpot(day, index) {
            if (confirm("確定刪除此景點？")) {
                userItinerary[day].splice(index, 1);
                localStorage.setItem('japan_user_itinerary', JSON.stringify(userItinerary));
                renderItinerary();
            }
        }

        function addUserNote(day) {
            const input = document.getElementById(`note-input-${day}`);
            const text = input.value.trim();
            if (!text) return;

            if (!userDayNotes[day]) userDayNotes[day] = [];
            userDayNotes[day].push(text);
            
            localStorage.setItem('japan_user_notes', JSON.stringify(userDayNotes));
            renderItinerary();
        }

        function removeUserNote(day, index) {
            if (confirm("確定刪除此備註？")) {
                userDayNotes[day].splice(index, 1);
                localStorage.setItem('japan_user_notes', JSON.stringify(userDayNotes));
                renderItinerary();
            }
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = itinerary.map((item, index) => {
                const userSpots = userItinerary[item.day] || [];
                const userSpotsHtml = userSpots.map((spot, i) => `
                    <div class="mt-2 bg-nordic-bg p-2 rounded flex justify-between items-center text-sm border border-dashed border-nordic-accent text-nordic-text">
                        <span><i class="fas fa-map-pin text-nordic-accent mr-1"></i> ${autoLink(spot)}</span>
                        <button onclick="removeUserSpot('${item.day}', ${i})" class="text-nordic-sub hover:text-nordic-red px-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');

                const userNotes = userDayNotes[item.day] || [];
                const userNotesHtml = userNotes.map((note, i) => `
                    <div class="mt-2 bg-yellow-50 p-2 rounded flex justify-between items-center text-sm border border-yellow-200 text-nordic-text">
                        <span><i class="fas fa-pen text-yellow-500 mr-2"></i>${note}</span>
                        <button onclick="removeUserNote('${item.day}', ${i})" class="text-nordic-sub hover:text-nordic-red px-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');

                return `
                <div class="bg-nordic-card p-5 rounded-lg border border-nordic-border ${item.highlight ? 'border-l-4 border-l-nordic-red' : ''}">
                    <div class="flex justify-between items-baseline mb-2">
                        <h4 class="font-bold text-lg text-nordic-text">
                            <span class="text-xs font-bold text-nordic-sub mr-2 bg-gray-100 px-2 py-1 rounded">${item.day}</span>
                            ${item.title}
                        </h4>
                        <span class="text-xs text-nordic-sub">${item.date}</span>
                    </div>
                    <p class="text-base text-nordic-text opacity-80 leading-relaxed mb-3">${autoLink(item.content)}</p>
                    
                    ${item.hotel ? `
                    <div class="mt-3 pt-3 border-t border-nordic-border flex items-center text-xs text-nordic-sub">
                        <i class="fas fa-bed mr-2 text-nordic-accent"></i>
                        <span>${item.hotel}</span>
                    </div>
                    ` : ''}

                    ${item.highlight ? `<span class="text-xs text-nordic-red font-bold block mt-2"><i class="fas fa-star mr-1"></i></span>` : ''}
                    
                    ${item.day !== 'D8' ? `
                    <div class="mt-2 text-right">
                         <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}" target="_blank" class="text-xs font-bold text-nordic-primary hover:underline">地圖 <i class="fas fa-chevron-right text-[10px]"></i></a>
                    </div>
                    ` : ''}

                    <!-- User Added Spots Section - Modified Width to 2/3 -->
                    <div class="mt-3 pt-2 border-t border-nordic-border">
                        ${userSpotsHtml}
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="spot-input-${item.day}" placeholder="自行加入景點..." class="w-2/3 border border-nordic-border rounded px-2 py-1 text-sm bg-nordic-bg focus:border-nordic-accent outline-none">
                            <button onclick="addUserSpot('${item.day}')" class="bg-nordic-accent text-white px-3 py-1 rounded text-sm font-bold hover:opacity-90"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- User Notes Section -->
                    <div class="mt-2">
                        ${userNotesHtml}
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="note-input-${item.day}" placeholder="自行加入備註..." class="w-2/3 border border-nordic-border rounded px-2 py-1 text-sm bg-nordic-bg focus:border-yellow-400 outline-none">
                            <button onclick="addUserNote('${item.day}')" class="bg-yellow-400 text-white px-3 py-1 rounded text-sm font-bold hover:opacity-90"><i class="fas fa-pen"></i></button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- Wallet Logic ---

        function calcRate() {
            const input = document.getElementById('calc-input').value;
            const display = document.getElementById('twd-preview');
            
            try {
                if(!input) {
                    display.innerText = "0";
                    return;
                }
                const safeInput = input.replace(/[^0-9+\-*/().]/g, '');
                const yen = eval(safeInput);
                if (!isNaN(yen)) {
                    const twd = Math.round(yen * currentRate);
                    display.innerText = twd;
                }
            } catch (e) {}
        }

        function calculateAndAdd() {
            const input = document.getElementById('calc-input').value;
            if(!input) return;
            try {
                const safeInput = input.replace(/[^0-9+\-*/().]/g, '');
                const result = eval(safeInput);
                if(!isNaN(result)) {
                    document.getElementById('item-price').value = Math.floor(result);
                    // Ensure currency is JPY when adding from calculator
                    document.getElementById('item-currency').value = 'JPY'; 
                    document.getElementById('calc-input').value = ""; 
                    document.getElementById('twd-preview').innerText = "0";
                    document.getElementById('item-name').focus();
                }
            } catch(e) {}
        }

        function handlePhotoSelect(input) {
            if (input.files && input.files[0]) {
                processImage(input.files[0], (base64) => {
                    tempPhotoData = base64;
                    document.getElementById('preview-img').src = tempPhotoData;
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('photo-label').innerText = "OK";
                });
            }
        }

        function processImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 500; 
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.7)); 
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function addExpense() {
            const name = document.getElementById('item-name').value;
            const price = parseFloat(document.getElementById('item-price').value);
            const currency = document.getElementById('item-currency').value;
            const payer = document.getElementById('item-payer').value;
            const day = document.getElementById('expense-day').value; // Get selected day
            
            if (!name || isNaN(price)) {
                alert("請輸入名稱與金額");
                return;
            }

            const newExpense = {
                id: Date.now(),
                name: name,
                amount: price,
                currency: currency,
                payer: payer,
                day: day, // Store the day
                img: tempPhotoData,
                date: new Date().toLocaleDateString()
            };

            expenses.unshift(newExpense);
            saveExpenses();
            renderExpenses();

            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('expense-photo').value = '';
            tempPhotoData = null;
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('photo-label').innerHTML = '存底圖';
        }

        function deleteExpense(id) {
            if(confirm('確定刪除此筆紀錄？')) {
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses();
                renderExpenses();
            }
        }

        function saveExpenses() {
            try {
                localStorage.setItem('japan_expenses', JSON.stringify(expenses));
            } catch (e) {
                alert("儲存失敗！可能是照片太多佔滿空間，請刪除部分舊紀錄。");
            }
        }

        function renderExpenses() {
            const container = document.getElementById('expense-list');
            let totalYen = 0;
            let totalTwd = 0;
            
            // Subtotals
            let totalTwdE = 0;
            let totalTwdH = 0;

            if (expenses.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-300 text-sm">尚未有記帳資料</div>';
                document.getElementById('total-expense').innerText = '總: NT$0';
                document.getElementById('subtotal-e').innerText = 'E: NT$0';
                document.getElementById('subtotal-h').innerText = 'H: NT$0';
                document.getElementById('split-result').innerText = '尚無分帳資料';
                return;
            }

            // Group expenses by day
            const groupedExpenses = {};
            // Initialize with all itinerary days to keep order
            itineraryDays.forEach(day => groupedExpenses[day] = []);
            groupedExpenses['Other'] = []; // For items without specific day or legacy data

            expenses.forEach(e => {
                const dayKey = e.day && itineraryDays.includes(e.day) ? e.day : 'Other';
                groupedExpenses[dayKey].push(e);
            });

            let htmlContent = '';

            // Helper to render individual expense item
            const renderItem = (e) => {
                const amount = e.amount || e.yen;
                const currency = e.currency || 'JPY';
                const payer = e.payer || 'E'; // Default to E if not set
                
                let displayYen, displayTwd;

                if (currency === 'JPY') {
                    displayYen = amount;
                    displayTwd = Math.round(amount * currentRate);
                } else {
                    displayTwd = amount;
                    displayYen = Math.round(amount / currentRate);
                }
                
                totalYen += displayYen;
                totalTwd += displayTwd;

                if (payer === 'E') {
                    totalTwdE += displayTwd;
                } else if (payer === 'H') {
                    totalTwdH += displayTwd;
                }

                const primaryText = currency === 'JPY' ? `¥${amount.toLocaleString()}` : `NT$${amount.toLocaleString()}`;
                const secondaryText = currency === 'JPY' ? `≈ NT$${displayTwd.toLocaleString()}` : `≈ ¥${displayYen.toLocaleString()}`;
                const payerBadgeClass = payer === 'E' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600';

                return `
                <div class="bg-nordic-card p-4 rounded-lg flex items-center justify-between border-b border-nordic-border last:border-0 mb-2 shadow-sm">
                    <div class="flex items-center gap-4 overflow-hidden">
                        ${e.img ? `<img src="${e.img}" class="w-12 h-12 rounded object-cover border border-nordic-border flex-shrink-0" onclick="showImage('${e.img}')">` : '<div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-gray-300"><i class="fas fa-shopping-bag"></i></div>'}
                        <div class="min-w-0">
                            <div class="font-bold text-nordic-text text-lg truncate">${e.name}</div>
                            <div class="text-xs text-nordic-sub flex items-center gap-2">
                                <span>${e.date}</span>
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border border-gray-200 ${payerBadgeClass}">${payer}</span>
                                <span class="bg-gray-100 px-1 rounded ml-1">${currency}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="font-bold text-nordic-text text-lg">${primaryText}</div>
                        <div class="text-xs text-nordic-sub">${secondaryText}</div>
                    </div>
                    <button onclick="deleteExpense(${e.id})" class="ml-3 text-gray-300 hover:text-nordic-red p-2"><i class="fas fa-trash-alt"></i></button>
                </div>
                `;
            };

            // Render groups
            // Sort keys: D1..D8, then Other. Note: 'Other' is already at the end if pushed last, or check specific order.
            // Using itineraryDays + 'Other'
            [...itineraryDays, 'Other'].forEach(day => {
                const groupItems = groupedExpenses[day];
                if (groupItems && groupItems.length > 0) {
                    // Calculate daily subtotal
                    let dailyTotal = 0;
                    groupItems.forEach(e => {
                        const amt = e.amount || e.yen;
                        const cur = e.currency || 'JPY';
                        // We want total in TWD based on user request "總額以台幣呈現"
                        // If item is JPY, convert to TWD. If item is TWD, use as is.
                        if (cur === 'JPY') dailyTotal += Math.round(amt * currentRate);
                        else dailyTotal += amt;
                    });

                    // Get display date for header
                    let headerText = day;
                    if (day !== 'Other') {
                        const itinItem = itinerary.find(i => i.day === day);
                        if (itinItem) headerText = itinItem.date; // Just the date string
                    } else {
                         headerText = "未分類 / 其他";
                    }

                    htmlContent += `
                        <div class="mb-5">
                            <h4 class="font-bold text-nordic-primary mb-2 flex justify-between items-center px-1 border-b-2 border-nordic-border pb-1">
                                <span>${headerText}</span>
                                <span class="text-sm">小計: NT$${dailyTotal.toLocaleString()}</span>
                            </h4>
                            <div class="space-y-2">
                                ${groupItems.map(renderItem).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = htmlContent;

            document.getElementById('total-expense').innerText = `總: NT$${totalTwd.toLocaleString()}`;
            document.getElementById('subtotal-e').innerText = `E: NT$${totalTwdE.toLocaleString()}`;
            document.getElementById('subtotal-h').innerText = `H: NT$${totalTwdH.toLocaleString()}`;

            // Calculate Split
            const diff = totalTwdE - totalTwdH;
            const splitAmount = Math.round(Math.abs(diff) / 2);
            let splitText = "目前兩清";

            if (diff > 0) {
                splitText = `H 需給 E: NT$${splitAmount.toLocaleString()}`;
            } else if (diff < 0) {
                splitText = `E 需給 H: NT$${splitAmount.toLocaleString()}`;
            }

            document.getElementById('split-result').innerHTML = `<i class="fas fa-hand-holding-usd mr-2 text-nordic-accent"></i>分帳: ${splitText}`;
        }

        function showImage(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        // --- Lists Logic ---

        function renderTodos() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = todos.map((t, i) => `
                <div class="p-4 flex items-center gap-4 ${t.done ? 'bg-gray-50' : 'bg-nordic-card'} transition-colors duration-200">
                    <button onclick="toggleTodo(${i})" class="text-xl ${t.done ? 'text-nordic-green' : 'text-gray-200 hover:text-gray-300'} transition">
                        <i class="fas ${t.done ? 'fa-check-square' : 'fa-square'}"></i>
                    </button>
                    <span class="${t.done ? 'line-through text-gray-400' : 'text-nordic-text'} flex-1 text-lg">${t.text}</span>
                    <button onclick="deleteTodo(${i})" class="text-gray-300 hover:text-nordic-red text-sm px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
            localStorage.setItem('japan_todos', JSON.stringify(todos));
        }

        function toggleTodo(index) {
            todos[index].done = !todos[index].done;
            renderTodos();
        }

        function addTodo() {
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if (text) {
                todos.push({ text: text, done: false });
                input.value = '';
                renderTodos();
            }
        }

        function deleteTodo(index) {
            todos.splice(index, 1);
            renderTodos();
        }

        function resetChecklist() {
            if(confirm("重置清單回到預設狀態？")) {
                todos = defaultTodos.map(t => ({ text: t, done: false }));
                renderTodos();
            }
        }

        function saveMemo() {
            const text = document.getElementById('memo-area').value;
            localStorage.setItem('japan_memo', text);
            renderMemoLinks();
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "已儲存";
            btn.classList.add('bg-nordic-text');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-nordic-text');
            }, 1000);
        }

        function renderMemoLinks() {
            const text = document.getElementById('memo-area').value;
            const container = document.getElementById('memo-links');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);

            if (matches) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="bg-gray-100 hover:bg-gray-200 text-nordic-primary border border-gray-200 px-4 py-2 rounded-full text-sm font-bold truncate max-w-full flex items-center gap-2 transition">
                        <i class="fas fa-link"></i> ${new URL(url).hostname}
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        function clearAllData() {
            if(confirm("警告：這將會刪除所有的記帳、清單與備忘錄資料，無法復原。確定嗎？")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- GEMINI AI FEATURES ---

        function openSettings() {
            const savedKey = localStorage.getItem('gemini_api_key') || '';
            const savedModel = localStorage.getItem('gemini_model') || 'gemini-1.5-flash';
            
            document.getElementById('api-key-input').value = savedKey;
            document.getElementById('model-select').value = savedModel;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            
            closeSettings();
            alert("設定已儲存！");
        }

        function getApiKey() {
            const userKey = localStorage.getItem('gemini_api_key');
            const envKey = (typeof apiKey !== 'undefined') ? apiKey : ""; 
            return userKey || envKey;
        }

        async function callGemini(payload) {
            const key = getApiKey();
            if (!key) {
                openSettings();
                throw new Error("No API Key");
            }

            const model = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "API Error: " + response.statusText);
            }
            return await response.json();
        }

        // 1. AI Receipt Scanner
        function handleAiScan(input) {
            if (input.files && input.files[0]) {
                const overlay = document.getElementById('ai-scan-loading');
                overlay.classList.remove('hidden');
                
                processImage(input.files[0], async (base64) => {
                    const cleanBase64 = base64.split(',')[1];
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: "Analyze this receipt image. Extract the main item name (a short summary in Traditional Chinese, e.g. '超商零食' or '拉麵') and the total amount in Yen. Return ONLY raw JSON format: { \"name\": \"string\", \"price\": number }. If it is not a receipt or unclear, return null." },
                                { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    };

                    try {
                        const data = await callGemini(payload);
                        const text = data.candidates[0].content.parts[0].text;
                        const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonText);

                        if (result) {
                            document.getElementById('item-name').value = result.name;
                            document.getElementById('item-price').value = result.price;
                            tempPhotoData = base64;
                            document.getElementById('preview-img').src = tempPhotoData;
                            document.getElementById('photo-preview-area').classList.remove('hidden');
                            document.getElementById('photo-label').innerText = "OK";
                        } else {
                            alert("無法辨識收據內容，請手動輸入。");
                        }
                    } catch (e) {
                        if (e.message === "No API Key") {
                             // Modal will open automatically
                        } else {
                            alert("辨識失敗: " + e.message);
                        }
                    } finally {
                        overlay.classList.add('hidden');
                        input.value = ''; 
                    }
                });
            }
        }

        // 2. AI Translator
        async function handleTranslate() {
            const text = document.getElementById('trans-input').value.trim();
            if (!text) return;

            const loading = document.getElementById('trans-loading');
            const resultDiv = document.getElementById('trans-result');
            const contentDiv = document.getElementById('trans-content');

            resultDiv.classList.remove('hidden');
            loading.classList.remove('hidden');
            contentDiv.innerHTML = '';

            const payload = {
                contents: [{
                    parts: [{
                        text: `You are a helpful translator for a traveler in Japan. Translate the following Traditional Chinese text to Japanese. 
                        Provide the output in this specific HTML format (no markdown code blocks):
                        <div class="text-xl font-bold text-nordic-text mb-2">{Japanese Text}</div>
                        <div class="text-sm text-nordic-sub mb-3 font-mono">{Romaji Pronunciation}</div>
                        <div class="text-sm text-nordic-primary bg-gray-50 p-3 rounded border border-nordic-border font-bold"><i class="fas fa-info-circle mr-2"></i>{A very brief politeness tip or cultural note}</div>
                        
                        Input: "${text}"`
                    }]
                }]
            };

            try {
                const data = await callGemini(payload);
                const html = data.candidates[0].content.parts[0].text;
                contentDiv.innerHTML = html.replace(/```html/g, '').replace(/```/g, '').trim();
            } catch (e) {
                 if (e.message !== "No API Key") {
                    contentDiv.innerText = "翻譯失敗: " + e.message;
                 }
            } finally {
                loading.classList.add('hidden');
            }
        }

    </script>
</body>
</html>